<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <meta name="author" content="maow" />
    <title>QEMU Develop Manual | maow</title>
    <link rel="icon" href="/favicon.gif" type="image/gif">
    <link href="/feed/" rel="alternate" title="maow" type="application/atom+xml" />
    <link rel="stylesheet" href="/media/css/style.css">
    <link rel="stylesheet" href="/media/css/highlight.css">
    <script type="text/javascript" src="/media/js/jquery-1.7.1.min.js"></script>
  </head>
  <body>
    <div id="container">
      <div id="main" role="main">
        <header>
        <h1>QEMU Develop Manual</h1>
        </header>
        <nav>
        <span><a title="home page" class="" href="/">home</a></span>
        <span><a title="about" class="" href="/about/">about</a></span>
        <span><a title="categories" class="" href="/categories/">categories</a></span>
        <span><a title="tags" class="" href="/tags/">tags</a></span>
        </nav>
        <article class="content">
        <section class="post">
<p>本文主要分析QEMU的建模API</p>

<h1 id="machine-api">Machine API</h1>

<h2 id="machine-register-api">Machine Register API</h2>

<h3 id="查看默认的machine">查看默认的Machine</h3>

<figure class="highlight"><pre><code class="language-shell" data-lang="shell"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13</pre></td><td class="code"><pre><span class="gp">$ </span>qemu-system-ppc -machine <span class="nb">help
</span>Supported machines are:
40p                  IBM RS/6000 7020 <span class="o">(</span>40p<span class="o">)</span>
bamboo               bamboo
g3beige              Heathrow based PowerMAC <span class="o">(</span>default<span class="o">)</span>
mac99                Mac99 based PowerMAC
mpc8544ds            mpc8544ds
none                 empty machine
ppce500              generic paravirt e500 platform
prep                 PowerPC PREP platform
ref405ep             ref405ep
taihu                taihu
virtex-ml507         Xilinx Virtex ML507 reference design<span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>

<h3 id="在makefile中添加配置选项">在Makefile中添加配置选项</h3>
<p>在PowerPC的默认配置选项中添加：</p>

<figure class="highlight"><pre><code class="language-make" data-lang="make"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3</pre></td><td class="code"><pre><span class="err">defaults-configs/ppc-softmmu.mak</span>

<span class="nv">CONFIG_VMC</span><span class="o">=</span><span class="err">y</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>

<p>在具体编译对象中添加：</p>

<figure class="highlight"><pre><code class="language-make" data-lang="make"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4</pre></td><td class="code"><pre><span class="err">hw/ppc/Makefile.objs</span>

<span class="c"># VMC
</span><span class="err">obj-$(CONFIG_VMC)</span> <span class="err">+=</span> <span class="err">vmc.o</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>

<h3 id="添加machine源码">添加Machine源码</h3>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38</pre></td><td class="code"><pre><span class="n">hw</span><span class="o">/</span><span class="n">ppc</span><span class="o">/</span><span class="n">vmc</span><span class="p">.</span><span class="n">c</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">ppc_vmc_init</span><span class="p">(</span><span class="n">MachineState</span> <span class="o">*</span><span class="n">machine</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">...</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">heathrow_kvm_type</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
    <span class="cm">/* Always force PR KVM */</span>
    <span class="k">return</span> <span class="mi">2</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">vmc_class_init</span><span class="p">(</span><span class="n">ObjectClass</span> <span class="o">*</span><span class="n">oc</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">MachineClass</span> <span class="o">*</span><span class="n">mc</span> <span class="o">=</span> <span class="n">MACHINE_CLASS</span><span class="p">(</span><span class="n">oc</span><span class="p">);</span>

    <span class="n">mc</span><span class="o">-&gt;</span><span class="n">desc</span>               <span class="o">=</span> <span class="s">"VMC PowerPC 755"</span><span class="p">;</span>
    <span class="n">mc</span><span class="o">-&gt;</span><span class="n">init</span>               <span class="o">=</span> <span class="n">ppc_vmc_init</span><span class="p">;</span>
    <span class="n">mc</span><span class="o">-&gt;</span><span class="n">block_default_type</span> <span class="o">=</span> <span class="n">IF_PFLASH</span><span class="p">;</span>
    <span class="n">mc</span><span class="o">-&gt;</span><span class="n">max_cpus</span>           <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">mc</span><span class="o">-&gt;</span><span class="n">default_boot_order</span> <span class="o">=</span> <span class="s">"cd"</span><span class="p">;</span>
    <span class="n">mc</span><span class="o">-&gt;</span><span class="n">kvm_type</span>           <span class="o">=</span> <span class="n">heathrow_kvm_type</span><span class="p">;</span>
    <span class="n">mc</span><span class="o">-&gt;</span><span class="n">default_cpu_type</span>   <span class="o">=</span> <span class="n">POWERPC_CPU_TYPE_NAME</span><span class="p">(</span><span class="s">"755_v2.8"</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="n">TypeInfo</span> <span class="n">ppc_vmc_machine_info</span> <span class="o">=</span> <span class="p">{</span>
    <span class="p">.</span><span class="n">name</span>          <span class="o">=</span> <span class="n">MACHINE_TYPE_NAME</span><span class="p">(</span><span class="s">"VMC"</span><span class="p">),</span>
    <span class="p">.</span><span class="n">parent</span>        <span class="o">=</span> <span class="n">TYPE_MACHINE</span><span class="p">,</span>
    <span class="p">.</span><span class="n">class_init</span>    <span class="o">=</span> <span class="n">vmc_class_init</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ppc_vmc_register_types</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">type_register_static</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ppc_vmc_machine_info</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">type_init</span><span class="p">(</span><span class="n">ppc_vmc_register_types</span><span class="p">);</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>

<p>添加了这些代码，编译后在查看Machine</p>

<figure class="highlight"><pre><code class="language-shell" data-lang="shell"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14</pre></td><td class="code"><pre><span class="gp">$ </span>qemu-system-ppc -machine <span class="nb">help
</span>Supported machines are:
40p                  IBM RS/6000 7020 <span class="o">(</span>40p<span class="o">)</span>
VMC                  VMC PowerPC 755
bamboo               bamboo
g3beige              Heathrow based PowerMAC <span class="o">(</span>default<span class="o">)</span>
mac99                Mac99 based PowerMAC
mpc8544ds            mpc8544ds
none                 empty machine
ppce500              generic paravirt e500 platform
prep                 PowerPC PREP platform
ref405ep             ref405ep
taihu                taihu
virtex-ml507         Xilinx Virtex ML507 reference design<span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>

<p>MachineClass结构体定义：</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58</pre></td><td class="code"><pre><span class="n">include</span><span class="o">/</span><span class="n">hw</span><span class="o">/</span><span class="n">boards</span><span class="p">.</span><span class="n">h</span>

<span class="k">struct</span> <span class="n">MachineClass</span> <span class="p">{</span>
    <span class="cm">/*&lt; private &gt;*/</span>
    <span class="n">ObjectClass</span> <span class="n">parent_class</span><span class="p">;</span>
    <span class="cm">/*&lt; public &gt;*/</span>

    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">family</span><span class="p">;</span> <span class="cm">/* NULL iff @name identifies a standalone machtype */</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>
    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">alias</span><span class="p">;</span>
    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">desc</span><span class="p">;</span>

    <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">init</span><span class="p">)(</span><span class="n">MachineState</span> <span class="o">*</span><span class="n">state</span><span class="p">);</span>
    <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">reset</span><span class="p">)(</span><span class="kt">void</span><span class="p">);</span>
    <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">hot_add_cpu</span><span class="p">)(</span><span class="k">const</span> <span class="kt">int64_t</span> <span class="n">id</span><span class="p">,</span> <span class="n">Error</span> <span class="o">**</span><span class="n">errp</span><span class="p">);</span>
    <span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">kvm_type</span><span class="p">)(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">arg</span><span class="p">);</span>

    <span class="n">BlockInterfaceType</span> <span class="n">block_default_type</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">units_per_default_bus</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">max_cpus</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">min_cpus</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">default_cpus</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">no_serial</span><span class="o">:</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">no_parallel</span><span class="o">:</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">use_virtcon</span><span class="o">:</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">use_sclp</span><span class="o">:</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">no_floppy</span><span class="o">:</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">no_cdrom</span><span class="o">:</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">no_sdcard</span><span class="o">:</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">has_dynamic_sysbus</span><span class="o">:</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">pci_allow_0_address</span><span class="o">:</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">legacy_fw_cfg_order</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">is_default</span><span class="p">;</span>
    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">default_machine_opts</span><span class="p">;</span>
    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">default_boot_order</span><span class="p">;</span>
    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">default_display</span><span class="p">;</span>
    <span class="n">GArray</span> <span class="o">*</span><span class="n">compat_props</span><span class="p">;</span>
    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">hw_version</span><span class="p">;</span>
    <span class="n">ram_addr_t</span> <span class="n">default_ram_size</span><span class="p">;</span>
    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">default_cpu_type</span><span class="p">;</span>
    <span class="n">bool</span> <span class="n">option_rom_has_mr</span><span class="p">;</span>
    <span class="n">bool</span> <span class="n">rom_file_has_mr</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">minimum_page_bits</span><span class="p">;</span>
    <span class="n">bool</span> <span class="n">has_hotpluggable_cpus</span><span class="p">;</span>
    <span class="n">bool</span> <span class="n">ignore_memory_transaction_failures</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">numa_mem_align_shift</span><span class="p">;</span>
    <span class="k">const</span> <span class="kt">char</span> <span class="o">**</span><span class="n">valid_cpu_types</span><span class="p">;</span>
    <span class="n">bool</span> <span class="n">auto_enable_numa_with_memhp</span><span class="p">;</span>
    <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">numa_auto_assign_ram</span><span class="p">)(</span><span class="n">MachineClass</span> <span class="o">*</span><span class="n">mc</span><span class="p">,</span> <span class="n">NodeInfo</span> <span class="o">*</span><span class="n">nodes</span><span class="p">,</span>
                                 <span class="kt">int</span> <span class="n">nb_nodes</span><span class="p">,</span> <span class="n">ram_addr_t</span> <span class="n">size</span><span class="p">);</span>

    <span class="n">HotplugHandler</span> <span class="o">*</span><span class="p">(</span><span class="o">*</span><span class="n">get_hotplug_handler</span><span class="p">)(</span><span class="n">MachineState</span> <span class="o">*</span><span class="n">machine</span><span class="p">,</span>
                                           <span class="n">DeviceState</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
    <span class="n">CpuInstanceProperties</span> <span class="p">(</span><span class="o">*</span><span class="n">cpu_index_to_instance_props</span><span class="p">)(</span><span class="n">MachineState</span> <span class="o">*</span><span class="n">machine</span><span class="p">,</span>
                                                         <span class="kt">unsigned</span> <span class="n">cpu_index</span><span class="p">);</span>
    <span class="k">const</span> <span class="n">CPUArchIdList</span> <span class="o">*</span><span class="p">(</span><span class="o">*</span><span class="n">possible_cpu_arch_ids</span><span class="p">)(</span><span class="n">MachineState</span> <span class="o">*</span><span class="n">machine</span><span class="p">);</span>
    <span class="kt">int64_t</span> <span class="p">(</span><span class="o">*</span><span class="n">get_default_cpu_node_id</span><span class="p">)(</span><span class="k">const</span> <span class="n">MachineState</span> <span class="o">*</span><span class="n">ms</span><span class="p">,</span> <span class="kt">int</span> <span class="n">idx</span><span class="p">);</span>
<span class="p">};</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>

<p>block_default_type的类型：</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12</pre></td><td class="code"><pre><span class="n">include</span><span class="o">/</span><span class="n">sysemu</span><span class="o">/</span><span class="n">blockdev</span><span class="p">.</span><span class="n">h</span>

<span class="k">typedef</span> <span class="k">enum</span> <span class="p">{</span>
    <span class="n">IF_DEFAULT</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>            <span class="cm">/* for use with drive_add() only */</span>
    <span class="cm">/*
     * IF_NONE must be zero, because we want MachineClass member
     * block_default_type to default-initialize to IF_NONE
     */</span>
    <span class="n">IF_NONE</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">IF_IDE</span><span class="p">,</span> <span class="n">IF_SCSI</span><span class="p">,</span> <span class="n">IF_FLOPPY</span><span class="p">,</span> <span class="n">IF_PFLASH</span><span class="p">,</span> <span class="n">IF_MTD</span><span class="p">,</span> <span class="n">IF_SD</span><span class="p">,</span> <span class="n">IF_VIRTIO</span><span class="p">,</span> <span class="n">IF_XEN</span><span class="p">,</span>
    <span class="n">IF_COUNT</span>
<span class="p">}</span> <span class="n">BlockInterfaceType</span><span class="p">;</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>

<h3 id="查看默认的cpu">查看默认的CPU</h3>

<figure class="highlight"><pre><code class="language-shell" data-lang="shell"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7</pre></td><td class="code"><pre><span class="gp">$ </span>qemu-system-ppc -cpu <span class="nb">help</span>
...
PowerPC 755_v2.8         PVR 00083208
PowerPC 755              <span class="o">(</span><span class="nb">alias </span><span class="k">for </span>755_v2.8<span class="o">)</span>
...
PowerPC e500             <span class="o">(</span><span class="nb">alias </span><span class="k">for </span>e500v2_v22<span class="o">)</span>
...<span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>

<h1 id="内存">内存</h1>

<h2 id="memory">Memory</h2>
<p>使用Gnome的GLib：</p>
<blockquote>
  <p>GLib provides the core application building blocks for libraries and
applications written in C. It provides the core object system used in GNOME,
the main loop implementation, and a large set of utility functions for
strings and common data structures.</p>
</blockquote>

<h2 id="memory-allocation">Memory Allocation</h2>
<p><a href="https://developer.gnome.org/glib/unstable/glib-Memory
-Allocation.html">Memory Allocation</a> — general memory-handling</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36</pre></td><td class="code"><pre><span class="cp">#include &lt;glib.h&gt;
</span>
<span class="n">These</span> <span class="n">functions</span> <span class="n">provide</span> <span class="n">support</span> <span class="k">for</span> <span class="n">allocating</span> <span class="n">and</span> <span class="n">freeing</span> <span class="n">memory</span><span class="p">.</span>

<span class="n">If</span> <span class="n">any</span> <span class="n">call</span> <span class="n">to</span> <span class="n">allocate</span> <span class="n">memory</span> <span class="n">using</span> <span class="n">functions</span> <span class="n">g_new</span><span class="p">(),</span> <span class="n">g_new0</span><span class="p">(),</span> <span class="n">g_renew</span><span class="p">(),</span>
<span class="n">g_malloc</span><span class="p">(),</span> <span class="n">g_malloc0</span><span class="p">(),</span> <span class="n">g_malloc0_n</span><span class="p">(),</span> <span class="n">g_realloc</span><span class="p">(),</span> <span class="n">and</span> <span class="n">g_realloc_n</span><span class="p">()</span> <span class="n">fails</span><span class="p">,</span>
<span class="n">the</span> <span class="n">application</span> <span class="n">is</span> <span class="n">terminated</span><span class="p">.</span> <span class="n">This</span> <span class="n">also</span> <span class="n">means</span> <span class="n">that</span> <span class="n">there</span> <span class="n">is</span> <span class="n">no</span> <span class="n">need</span> <span class="n">to</span> <span class="n">check</span>
<span class="k">if</span> <span class="n">the</span> <span class="n">call</span> <span class="n">succeeded</span><span class="p">.</span> <span class="n">On</span> <span class="n">the</span> <span class="n">other</span> <span class="n">hand</span><span class="p">,</span> <span class="n">g_try_</span><span class="p">...()</span> <span class="n">family</span> <span class="n">of</span> <span class="n">functions</span>
<span class="n">returns</span> <span class="nb">NULL</span> <span class="n">on</span> <span class="n">failure</span> <span class="n">that</span> <span class="n">can</span> <span class="n">be</span> <span class="n">used</span> <span class="n">as</span> <span class="n">a</span> <span class="n">check</span> <span class="k">for</span> <span class="n">unsuccessful</span> <span class="n">memory</span>
<span class="n">allocation</span><span class="p">.</span> <span class="n">The</span> <span class="n">application</span> <span class="n">is</span> <span class="n">not</span> <span class="n">terminated</span> <span class="n">in</span> <span class="n">this</span> <span class="k">case</span><span class="p">.</span>

<span class="n">It</span><span class="err">'</span><span class="n">s</span> <span class="n">important</span> <span class="n">to</span> <span class="n">match</span> <span class="n">g_malloc</span><span class="p">()</span> <span class="p">(</span><span class="n">and</span> <span class="n">wrappers</span> <span class="n">such</span> <span class="n">as</span> <span class="n">g_new</span><span class="p">())</span> <span class="n">with</span>
<span class="n">g_free</span><span class="p">(),</span> <span class="n">g_slice_alloc</span><span class="p">()</span> <span class="p">(</span><span class="n">and</span> <span class="n">wrappers</span> <span class="n">such</span> <span class="n">as</span> <span class="n">g_slice_new</span><span class="p">())</span> <span class="n">with</span>
<span class="n">g_slice_free</span><span class="p">(),</span> <span class="n">plain</span> <span class="n">malloc</span><span class="p">()</span> <span class="n">with</span> <span class="n">free</span><span class="p">(),</span> <span class="n">and</span> <span class="p">(</span><span class="k">if</span> <span class="n">you</span><span class="err">'</span><span class="n">re</span> <span class="n">using</span> <span class="n">C</span><span class="o">++</span><span class="p">)</span>
<span class="n">new</span> <span class="n">with</span> <span class="n">delete</span> <span class="n">and</span> <span class="n">new</span><span class="p">[]</span> <span class="n">with</span> <span class="n">delete</span><span class="p">[].</span> <span class="n">Otherwise</span> <span class="n">bad</span> <span class="n">things</span> <span class="n">can</span> <span class="n">happen</span><span class="p">,</span>
<span class="n">since</span> <span class="n">these</span> <span class="n">allocators</span> <span class="n">may</span> <span class="n">use</span> <span class="n">different</span> <span class="n">memory</span> <span class="n">pools</span> <span class="p">(</span><span class="n">and</span> <span class="n">new</span><span class="o">/</span><span class="n">delete</span> <span class="n">call</span>
<span class="n">constructors</span> <span class="n">and</span> <span class="n">destructors</span><span class="p">).</span>

<span class="n">functions</span>

<span class="cp">#define             g_new(struct_type, n_structs)
</span>
<span class="n">Allocates</span> <span class="n">n_structs</span> <span class="n">elements</span> <span class="n">of</span> <span class="n">type</span> <span class="n">struct_type</span> <span class="p">.</span> <span class="n">The</span> <span class="n">returned</span> <span class="n">pointer</span> <span class="n">is</span>
<span class="n">cast</span> <span class="n">to</span> <span class="n">a</span> <span class="n">pointer</span> <span class="n">to</span> <span class="n">the</span> <span class="n">given</span> <span class="n">type</span><span class="p">.</span> <span class="n">If</span> <span class="n">n_structs</span> <span class="n">is</span> <span class="mi">0</span> <span class="n">it</span> <span class="n">returns</span> <span class="nb">NULL</span><span class="p">.</span> <span class="n">Care</span>
<span class="n">is</span> <span class="n">taken</span> <span class="n">to</span> <span class="n">avoid</span> <span class="n">overflow</span> <span class="n">when</span> <span class="n">calculating</span> <span class="n">the</span> <span class="n">size</span> <span class="n">of</span> <span class="n">the</span> <span class="n">allocated</span> <span class="n">block</span><span class="p">.</span>

<span class="n">Since</span> <span class="n">the</span> <span class="n">returned</span> <span class="n">pointer</span> <span class="n">is</span> <span class="n">already</span> <span class="n">casted</span> <span class="n">to</span> <span class="n">the</span> <span class="n">right</span> <span class="n">type</span><span class="p">,</span> <span class="n">it</span> <span class="n">is</span>
<span class="n">normally</span> <span class="n">unnecessary</span> <span class="n">to</span> <span class="n">cast</span> <span class="n">it</span> <span class="n">explicitly</span><span class="p">,</span> <span class="n">and</span> <span class="n">doing</span> <span class="n">so</span> <span class="n">might</span> <span class="n">hide</span>
<span class="n">memory</span> <span class="n">allocation</span> <span class="n">errors</span><span class="p">.</span>

<span class="n">Parameters</span>
    <span class="n">struct_type</span> <span class="n">the</span> <span class="n">type</span> <span class="n">of</span> <span class="n">the</span> <span class="n">elements</span> <span class="n">to</span> <span class="n">allocate</span>
    <span class="n">n_structs</span>   <span class="n">the</span> <span class="n">number</span> <span class="n">of</span> <span class="n">elements</span> <span class="n">to</span> <span class="n">allocate</span>

<span class="n">Returns</span>
    <span class="n">a</span> <span class="n">pointer</span> <span class="n">to</span> <span class="n">the</span> <span class="n">allocated</span> <span class="n">memory</span><span class="p">,</span> <span class="n">cast</span> <span class="n">to</span> <span class="n">a</span> <span class="n">pointer</span> <span class="n">to</span> <span class="n">struct_type</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>

<h2 id="memoryregion">MemoryRegion</h2>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42</pre></td><td class="code"><pre><span class="n">include</span><span class="o">/</span><span class="n">exec</span><span class="o">/</span><span class="n">memory</span><span class="p">.</span><span class="n">h</span>

<span class="k">struct</span> <span class="n">MemoryRegion</span> <span class="p">{</span>
    <span class="n">Object</span> <span class="n">parent_obj</span><span class="p">;</span>

    <span class="cm">/* All fields are private - violators will be prosecuted */</span>

    <span class="cm">/* The following fields should fit in a cache line */</span>
    <span class="n">bool</span> <span class="n">romd_mode</span><span class="p">;</span>
    <span class="n">bool</span> <span class="n">ram</span><span class="p">;</span>
    <span class="n">bool</span> <span class="n">subpage</span><span class="p">;</span>
    <span class="n">bool</span> <span class="n">readonly</span><span class="p">;</span> <span class="cm">/* For RAM regions */</span>
    <span class="n">bool</span> <span class="n">rom_device</span><span class="p">;</span>
    <span class="n">bool</span> <span class="n">flush_coalesced_mmio</span><span class="p">;</span>
    <span class="n">bool</span> <span class="n">global_locking</span><span class="p">;</span>
    <span class="kt">uint8_t</span> <span class="n">dirty_log_mask</span><span class="p">;</span>
    <span class="n">bool</span> <span class="n">is_iommu</span><span class="p">;</span>
    <span class="n">RAMBlock</span> <span class="o">*</span><span class="n">ram_block</span><span class="p">;</span>
    <span class="n">Object</span> <span class="o">*</span><span class="n">owner</span><span class="p">;</span>

    <span class="k">const</span> <span class="n">MemoryRegionOps</span> <span class="o">*</span><span class="n">ops</span><span class="p">;</span>
    <span class="kt">void</span> <span class="o">*</span><span class="n">opaque</span><span class="p">;</span>
    <span class="n">MemoryRegion</span> <span class="o">*</span><span class="n">container</span><span class="p">;</span>
    <span class="n">Int128</span> <span class="n">size</span><span class="p">;</span>
    <span class="n">hwaddr</span> <span class="n">addr</span><span class="p">;</span>
    <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">destructor</span><span class="p">)(</span><span class="n">MemoryRegion</span> <span class="o">*</span><span class="n">mr</span><span class="p">);</span>
    <span class="kt">uint64_t</span> <span class="n">align</span><span class="p">;</span>
    <span class="n">bool</span> <span class="n">terminates</span><span class="p">;</span>
    <span class="n">bool</span> <span class="n">ram_device</span><span class="p">;</span>
    <span class="n">bool</span> <span class="n">enabled</span><span class="p">;</span>
    <span class="n">bool</span> <span class="n">warning_printed</span><span class="p">;</span> <span class="cm">/* For reservations */</span>
    <span class="kt">uint8_t</span> <span class="n">vga_logging_count</span><span class="p">;</span>
    <span class="n">MemoryRegion</span> <span class="o">*</span><span class="n">alias</span><span class="p">;</span>
    <span class="n">hwaddr</span> <span class="n">alias_offset</span><span class="p">;</span>
    <span class="kt">int32_t</span> <span class="n">priority</span><span class="p">;</span>
    <span class="n">QTAILQ_HEAD</span><span class="p">(</span><span class="n">subregions</span><span class="p">,</span> <span class="n">MemoryRegion</span><span class="p">)</span> <span class="n">subregions</span><span class="p">;</span>
    <span class="n">QTAILQ_ENTRY</span><span class="p">(</span><span class="n">MemoryRegion</span><span class="p">)</span> <span class="n">subregions_link</span><span class="p">;</span>
    <span class="n">QTAILQ_HEAD</span><span class="p">(</span><span class="n">coalesced_ranges</span><span class="p">,</span> <span class="n">CoalescedMemoryRange</span><span class="p">)</span> <span class="n">coalesced</span><span class="p">;</span>
    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="n">ioeventfd_nb</span><span class="p">;</span>
    <span class="n">MemoryRegionIoeventfd</span> <span class="o">*</span><span class="n">ioeventfds</span><span class="p">;</span>
<span class="p">};</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>

<h2 id="ramblock">RAMBlock</h2>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29</pre></td><td class="code"><pre><span class="n">include</span><span class="o">/</span><span class="n">exec</span><span class="o">/</span><span class="n">ram_addr</span><span class="p">.</span><span class="n">h</span>

<span class="k">struct</span> <span class="n">RAMBlock</span> <span class="p">{</span>
    <span class="k">struct</span> <span class="n">rcu_head</span> <span class="n">rcu</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">MemoryRegion</span> <span class="o">*</span><span class="n">mr</span><span class="p">;</span>
    <span class="kt">uint8_t</span> <span class="o">*</span><span class="n">host</span><span class="p">;</span>
    <span class="n">ram_addr_t</span> <span class="n">offset</span><span class="p">;</span>
    <span class="n">ram_addr_t</span> <span class="n">used_length</span><span class="p">;</span>
    <span class="n">ram_addr_t</span> <span class="n">max_length</span><span class="p">;</span>
    <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">resized</span><span class="p">)(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span><span class="p">,</span> <span class="kt">uint64_t</span> <span class="n">length</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">host</span><span class="p">);</span>
    <span class="kt">uint32_t</span> <span class="n">flags</span><span class="p">;</span>
    <span class="cm">/* Protected by iothread lock.  */</span>
    <span class="kt">char</span> <span class="n">idstr</span><span class="p">[</span><span class="mi">256</span><span class="p">];</span>
    <span class="cm">/* RCU-enabled, writes protected by the ramlist lock */</span>
    <span class="n">QLIST_ENTRY</span><span class="p">(</span><span class="n">RAMBlock</span><span class="p">)</span> <span class="n">next</span><span class="p">;</span>
    <span class="n">QLIST_HEAD</span><span class="p">(,</span> <span class="n">RAMBlockNotifier</span><span class="p">)</span> <span class="n">ramblock_notifiers</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">fd</span><span class="p">;</span>
    <span class="kt">size_t</span> <span class="n">page_size</span><span class="p">;</span>
    <span class="cm">/* dirty bitmap used during migration */</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">bmap</span><span class="p">;</span>
    <span class="cm">/* bitmap of pages that haven't been sent even once
     * only maintained and used in postcopy at the moment
     * where it's used to send the dirtymap at the start
     * of the postcopy phase
     */</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">unsentmap</span><span class="p">;</span>
    <span class="cm">/* bitmap of already received pages in postcopy */</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">receivedmap</span><span class="p">;</span>
<span class="p">};</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>

<h2 id="get_system_memory">get_system_memory()</h2>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6</pre></td><td class="code"><pre><span class="n">exec</span><span class="p">.</span><span class="n">c</span>

<span class="n">MemoryRegion</span> <span class="o">*</span><span class="n">get_system_memory</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="n">system_memory</span><span class="p">;</span>
<span class="p">}</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>

<h2 id="memory_region_allocate_system_memory">memory_region_allocate_system_memory()</h2>
<p>头文件</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34</pre></td><td class="code"><pre><span class="n">include</span><span class="o">/</span><span class="n">hw</span><span class="o">/</span><span class="n">boards</span><span class="p">.</span><span class="n">h</span>

<span class="cm">/**
 * memory_region_allocate_system_memory - Allocate a board's main memory
 * @mr: the #MemoryRegion to be initialized
 * @owner: the object that tracks the region's reference count
 * @name: name of the memory region
 * @ram_size: size of the region in bytes
 *
 * This function allocates the main memory for a board model, and
 * initializes @mr appropriately. It also arranges for the memory
 * to be migrated (by calling vmstate_register_ram_global()).
 *
 * Memory allocated via this function will be backed with the memory
 * backend the user provided using "-mem-path" or "-numa node,memdev=..."
 * if appropriate; this is typically used to cause host huge pages to be
 * used. This function should therefore be called by a board exactly once,
 * for the primary or largest RAM area it implements.
 *
 * For boards where the major RAM is split into two parts in the memory
 * map, you can deal with this by calling memory_region_allocate_system_memory()
 * once to get a MemoryRegion with enough RAM for both parts, and then
 * creating alias MemoryRegions via memory_region_init_alias() which
 * alias into different parts of the RAM MemoryRegion and can be mapped
 * into the memory map in the appropriate places.
 *
 * Smaller pieces of memory (display RAM, static RAMs, etc) don't need
 * to be backed via the -mem-path memory backend and can simply
 * be created via memory_region_allocate_aux_memory() or
 * memory_region_init_ram().
 */</span>
<span class="kt">void</span> <span class="n">memory_region_allocate_system_memory</span><span class="p">(</span><span class="n">MemoryRegion</span> <span class="o">*</span><span class="n">mr</span><span class="p">,</span> <span class="n">Object</span> <span class="o">*</span><span class="n">owner</span><span class="p">,</span>
                                          <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span>
                                          <span class="kt">uint64_t</span> <span class="n">ram_size</span><span class="p">);</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>

<p>函数体</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68</pre></td><td class="code"><pre><span class="n">numa</span><span class="p">.</span><span class="n">c</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">allocate_system_memory_nonnuma</span><span class="p">(</span><span class="n">MemoryRegion</span> <span class="o">*</span><span class="n">mr</span><span class="p">,</span> <span class="n">Object</span> <span class="o">*</span><span class="n">owner</span><span class="p">,</span>
                                           <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span>
                                           <span class="kt">uint64_t</span> <span class="n">ram_size</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">mem_path</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifdef __linux__
</span>        <span class="n">Error</span> <span class="o">*</span><span class="n">err</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
        <span class="n">memory_region_init_ram_from_file</span><span class="p">(</span><span class="n">mr</span><span class="p">,</span> <span class="n">owner</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">ram_size</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span>
                                         <span class="n">mem_path</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">err</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">error_report_err</span><span class="p">(</span><span class="n">err</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">mem_prealloc</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
            <span class="p">}</span>

            <span class="cm">/* Legacy behavior: if allocation failed, fall back to
             * regular RAM allocation.
             */</span>
            <span class="n">memory_region_init_ram_nomigrate</span><span class="p">(</span><span class="n">mr</span><span class="p">,</span> <span class="n">owner</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">ram_size</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">error_fatal</span><span class="p">);</span>
        <span class="p">}</span>
<span class="cp">#else
</span>        <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"-mem-path not supported on this host</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
        <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="cp">#endif
</span>    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="n">memory_region_init_ram_nomigrate</span><span class="p">(</span><span class="n">mr</span><span class="p">,</span> <span class="n">owner</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">ram_size</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">error_fatal</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">vmstate_register_ram_global</span><span class="p">(</span><span class="n">mr</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">memory_region_allocate_system_memory</span><span class="p">(</span><span class="n">MemoryRegion</span> <span class="o">*</span><span class="n">mr</span><span class="p">,</span> <span class="n">Object</span> <span class="o">*</span><span class="n">owner</span><span class="p">,</span>
                                          <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span>
                                          <span class="kt">uint64_t</span> <span class="n">ram_size</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">uint64_t</span> <span class="n">addr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">nb_numa_nodes</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="o">!</span><span class="n">have_memdevs</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">allocate_system_memory_nonnuma</span><span class="p">(</span><span class="n">mr</span><span class="p">,</span> <span class="n">owner</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">ram_size</span><span class="p">);</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">memory_region_init</span><span class="p">(</span><span class="n">mr</span><span class="p">,</span> <span class="n">owner</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">ram_size</span><span class="p">);</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nb_numa_nodes</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="kt">uint64_t</span> <span class="n">size</span> <span class="o">=</span> <span class="n">numa_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">node_mem</span><span class="p">;</span>
        <span class="n">HostMemoryBackend</span> <span class="o">*</span><span class="n">backend</span> <span class="o">=</span> <span class="n">numa_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">node_memdev</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">backend</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">continue</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">MemoryRegion</span> <span class="o">*</span><span class="n">seg</span> <span class="o">=</span> <span class="n">host_memory_backend_get_memory</span><span class="p">(</span><span class="n">backend</span><span class="p">,</span>
                                                           <span class="o">&amp;</span><span class="n">error_fatal</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">memory_region_is_mapped</span><span class="p">(</span><span class="n">seg</span><span class="p">))</span> <span class="p">{</span>
            <span class="kt">char</span> <span class="o">*</span><span class="n">path</span> <span class="o">=</span> <span class="n">object_get_canonical_path_component</span><span class="p">(</span><span class="n">OBJECT</span><span class="p">(</span><span class="n">backend</span><span class="p">));</span>
            <span class="n">error_report</span><span class="p">(</span><span class="s">"memory backend %s is used multiple times. Each "</span>
                         <span class="s">"-numa option must use a different memdev value."</span><span class="p">,</span>
                         <span class="n">path</span><span class="p">);</span>
            <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="n">host_memory_backend_set_mapped</span><span class="p">(</span><span class="n">backend</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
        <span class="n">memory_region_add_subregion</span><span class="p">(</span><span class="n">mr</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">seg</span><span class="p">);</span>
        <span class="n">vmstate_register_ram_global</span><span class="p">(</span><span class="n">seg</span><span class="p">);</span>
        <span class="n">addr</span> <span class="o">+=</span> <span class="n">size</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15</pre></td><td class="code"><pre><span class="n">memory</span><span class="p">.</span><span class="n">c</span>

<span class="kt">void</span> <span class="n">memory_region_init_ram_nomigrate</span><span class="p">(</span><span class="n">MemoryRegion</span> <span class="o">*</span><span class="n">mr</span><span class="p">,</span>
                                      <span class="n">Object</span> <span class="o">*</span><span class="n">owner</span><span class="p">,</span>
                                      <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span>
                                      <span class="kt">uint64_t</span> <span class="n">size</span><span class="p">,</span>
                                      <span class="n">Error</span> <span class="o">**</span><span class="n">errp</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">memory_region_init</span><span class="p">(</span><span class="n">mr</span><span class="p">,</span> <span class="n">owner</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
    <span class="n">mr</span><span class="o">-&gt;</span><span class="n">ram</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
    <span class="n">mr</span><span class="o">-&gt;</span><span class="n">terminates</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
    <span class="n">mr</span><span class="o">-&gt;</span><span class="n">destructor</span> <span class="o">=</span> <span class="n">memory_region_destructor_ram</span><span class="p">;</span>
    <span class="n">mr</span><span class="o">-&gt;</span><span class="n">ram_block</span> <span class="o">=</span> <span class="n">qemu_ram_alloc</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">mr</span><span class="p">,</span> <span class="n">errp</span><span class="p">);</span>
    <span class="n">mr</span><span class="o">-&gt;</span><span class="n">dirty_log_mask</span> <span class="o">=</span> <span class="n">tcg_enabled</span><span class="p">()</span> <span class="o">?</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">DIRTY_MEMORY_CODE</span><span class="p">)</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43</pre></td><td class="code"><pre><span class="n">exec</span><span class="p">.</span><span class="n">c</span>

<span class="k">static</span>
<span class="n">RAMBlock</span> <span class="o">*</span><span class="n">qemu_ram_alloc_internal</span><span class="p">(</span><span class="n">ram_addr_t</span> <span class="n">size</span><span class="p">,</span> <span class="n">ram_addr_t</span> <span class="n">max_size</span><span class="p">,</span>
                                  <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">resized</span><span class="p">)(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span><span class="p">,</span>
                                                  <span class="kt">uint64_t</span> <span class="n">length</span><span class="p">,</span>
                                                  <span class="kt">void</span> <span class="o">*</span><span class="n">host</span><span class="p">),</span>
                                  <span class="kt">void</span> <span class="o">*</span><span class="n">host</span><span class="p">,</span> <span class="n">bool</span> <span class="n">resizeable</span><span class="p">,</span>
                                  <span class="n">MemoryRegion</span> <span class="o">*</span><span class="n">mr</span><span class="p">,</span> <span class="n">Error</span> <span class="o">**</span><span class="n">errp</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">RAMBlock</span> <span class="o">*</span><span class="n">new_block</span><span class="p">;</span>
    <span class="n">Error</span> <span class="o">*</span><span class="n">local_err</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

    <span class="n">size</span> <span class="o">=</span> <span class="n">HOST_PAGE_ALIGN</span><span class="p">(</span><span class="n">size</span><span class="p">);</span>
    <span class="n">max_size</span> <span class="o">=</span> <span class="n">HOST_PAGE_ALIGN</span><span class="p">(</span><span class="n">max_size</span><span class="p">);</span>
    <span class="n">new_block</span> <span class="o">=</span> <span class="n">g_malloc0</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">new_block</span><span class="p">));</span>
    <span class="n">new_block</span><span class="o">-&gt;</span><span class="n">mr</span> <span class="o">=</span> <span class="n">mr</span><span class="p">;</span>
    <span class="n">new_block</span><span class="o">-&gt;</span><span class="n">resized</span> <span class="o">=</span> <span class="n">resized</span><span class="p">;</span>
    <span class="n">new_block</span><span class="o">-&gt;</span><span class="n">used_length</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span>
    <span class="n">new_block</span><span class="o">-&gt;</span><span class="n">max_length</span> <span class="o">=</span> <span class="n">max_size</span><span class="p">;</span>
    <span class="n">assert</span><span class="p">(</span><span class="n">max_size</span> <span class="o">&gt;=</span> <span class="n">size</span><span class="p">);</span>
    <span class="n">new_block</span><span class="o">-&gt;</span><span class="n">fd</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="n">new_block</span><span class="o">-&gt;</span><span class="n">page_size</span> <span class="o">=</span> <span class="n">getpagesize</span><span class="p">();</span>
    <span class="n">new_block</span><span class="o">-&gt;</span><span class="n">host</span> <span class="o">=</span> <span class="n">host</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">new_block</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">RAM_PREALLOC</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">resizeable</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">new_block</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">RAM_RESIZEABLE</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">ram_block_add</span><span class="p">(</span><span class="n">new_block</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">local_err</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">local_err</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">g_free</span><span class="p">(</span><span class="n">new_block</span><span class="p">);</span>
        <span class="n">error_propagate</span><span class="p">(</span><span class="n">errp</span><span class="p">,</span> <span class="n">local_err</span><span class="p">);</span>
        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">new_block</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">RAMBlock</span> <span class="o">*</span><span class="n">qemu_ram_alloc</span><span class="p">(</span><span class="n">ram_addr_t</span> <span class="n">size</span><span class="p">,</span> <span class="n">MemoryRegion</span> <span class="o">*</span><span class="n">mr</span><span class="p">,</span> <span class="n">Error</span> <span class="o">**</span><span class="n">errp</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="n">qemu_ram_alloc_internal</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span> <span class="n">mr</span><span class="p">,</span> <span class="n">errp</span><span class="p">);</span>
<span class="p">}</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>

<p>AddressSpace结构体</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19</pre></td><td class="code"><pre><span class="n">include</span><span class="o">/</span><span class="n">exec</span><span class="o">/</span><span class="n">memory</span><span class="p">.</span><span class="n">h</span>

<span class="cm">/**
 * AddressSpace: describes a mapping of addresses to #MemoryRegion objects
 */</span>
<span class="k">struct</span> <span class="n">AddressSpace</span> <span class="p">{</span>
    <span class="cm">/* All fields are private. */</span>
    <span class="k">struct</span> <span class="n">rcu_head</span> <span class="n">rcu</span><span class="p">;</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>
    <span class="n">MemoryRegion</span> <span class="o">*</span><span class="n">root</span><span class="p">;</span>

    <span class="cm">/* Accessed via RCU.  */</span>
    <span class="k">struct</span> <span class="n">FlatView</span> <span class="o">*</span><span class="n">current_map</span><span class="p">;</span>

    <span class="kt">int</span> <span class="n">ioeventfd_nb</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">MemoryRegionIoeventfd</span> <span class="o">*</span><span class="n">ioeventfds</span><span class="p">;</span>
    <span class="n">QTAILQ_HEAD</span><span class="p">(</span><span class="n">memory_listeners_as</span><span class="p">,</span> <span class="n">MemoryListener</span><span class="p">)</span> <span class="n">listeners</span><span class="p">;</span>
    <span class="n">QTAILQ_ENTRY</span><span class="p">(</span><span class="n">AddressSpace</span><span class="p">)</span> <span class="n">address_spaces_link</span><span class="p">;</span>
<span class="p">};</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15</pre></td><td class="code"><pre><span class="n">memory</span><span class="p">.</span><span class="n">c</span>

<span class="kt">void</span> <span class="n">address_space_init</span><span class="p">(</span><span class="n">AddressSpace</span> <span class="o">*</span><span class="n">as</span><span class="p">,</span> <span class="n">MemoryRegion</span> <span class="o">*</span><span class="n">root</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">memory_region_ref</span><span class="p">(</span><span class="n">root</span><span class="p">);</span>
    <span class="n">as</span><span class="o">-&gt;</span><span class="n">root</span> <span class="o">=</span> <span class="n">root</span><span class="p">;</span>
    <span class="n">as</span><span class="o">-&gt;</span><span class="n">current_map</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="n">as</span><span class="o">-&gt;</span><span class="n">ioeventfd_nb</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">as</span><span class="o">-&gt;</span><span class="n">ioeventfds</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="n">QTAILQ_INIT</span><span class="p">(</span><span class="o">&amp;</span><span class="n">as</span><span class="o">-&gt;</span><span class="n">listeners</span><span class="p">);</span>
    <span class="n">QTAILQ_INSERT_TAIL</span><span class="p">(</span><span class="o">&amp;</span><span class="n">address_spaces</span><span class="p">,</span> <span class="n">as</span><span class="p">,</span> <span class="n">address_spaces_link</span><span class="p">);</span>
    <span class="n">as</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="n">g_strdup</span><span class="p">(</span><span class="n">name</span> <span class="o">?</span> <span class="n">name</span> <span class="o">:</span> <span class="s">"anonymous"</span><span class="p">);</span>
    <span class="n">address_space_update_topology</span><span class="p">(</span><span class="n">as</span><span class="p">);</span>
    <span class="n">address_space_update_ioeventfds</span><span class="p">(</span><span class="n">as</span><span class="p">);</span>
<span class="p">}</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7</pre></td><td class="code"><pre><span class="n">memory</span><span class="p">.</span><span class="n">c</span>

<span class="k">static</span> <span class="n">QTAILQ_HEAD</span><span class="p">(</span><span class="n">memory_listeners</span><span class="p">,</span> <span class="n">MemoryListener</span><span class="p">)</span> <span class="n">memory_listeners</span>
    <span class="o">=</span> <span class="n">QTAILQ_HEAD_INITIALIZER</span><span class="p">(</span><span class="n">memory_listeners</span><span class="p">);</span>

<span class="k">static</span> <span class="n">QTAILQ_HEAD</span><span class="p">(,</span> <span class="n">AddressSpace</span><span class="p">)</span> <span class="n">address_spaces</span>
    <span class="o">=</span> <span class="n">QTAILQ_HEAD_INITIALIZER</span><span class="p">(</span><span class="n">address_spaces</span><span class="p">);</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>


</section>
<section class="meta">
<span class="author">
  <a href="http://hscs506.github.io">maow</a>
</span>
<span class="time">
  /
  <time datetime="2018-04-26">2018-04-26</time>
</span>
<br />
<span class="license">
  Published under <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/3.0/">(CC) BY-NC-SA</a>
</span>


<span class="categories">
  in categories
  
  <a href="/categories/#QEMU" title="QEMU">QEMU</a>&nbsp;
  
</span>


<span class="tags">
  tagged with
  
  <a href="/tags/#QEMU" title="QEMU">QEMU</a>&nbsp;
  
  <a href="/tags/#Develop" title="Develop">Develop</a>&nbsp;
  
</span>

</section>

        </article>
      </div>
    </div>
  </body>
</html>
